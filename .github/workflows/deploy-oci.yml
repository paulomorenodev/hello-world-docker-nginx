name: Deploy to OCI

# Trigger do workflow - executa em push para main e pull requests
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Permite execuÃ§Ã£o manual

# VariÃ¡veis de ambiente globais
env:
  DOCKER_IMAGE_NAME: hello-world-nginx
  OCI_REGION: us-ashburn-1 # Altere para sua regiÃ£o OCI
  CONTAINER_NAME: hello-world-app

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout do cÃ³digo
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
    
    # 2. Setup Docker Buildx
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    # 3. Login no OCI Container Registry
    - name: Login to OCI Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ secrets.OCI_REGISTRY_URL }}
        username: ${{ secrets.OCI_USERNAME }}
        password: ${{ secrets.OCI_AUTH_TOKEN }}
    
    # 4. Build e Push da imagem Docker
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: |
          ${{ secrets.OCI_REGISTRY_URL }}/${{ secrets.OCI_NAMESPACE }}/${{ env.DOCKER_IMAGE_NAME }}:latest
          ${{ secrets.OCI_REGISTRY_URL }}/${{ secrets.OCI_NAMESPACE }}/${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    # 5. Setup OCI CLI
    - name: Setup OCI CLI
      uses: oracle-actions/configure-oci-cli@v1.0
      with:
        user: ${{ secrets.OCI_USER_OCID }}
        fingerprint: ${{ secrets.OCI_FINGERPRINT }}
        tenancy: ${{ secrets.OCI_TENANCY_OCID }}
        region: ${{ env.OCI_REGION }}
        private-key: ${{ secrets.OCI_PRIVATE_KEY }}
    
    # 6. Deploy usando OCI Container Instances
    - name: Deploy to OCI Container Instances
      run: |
        # Verificar se jÃ¡ existe uma instÃ¢ncia
        EXISTING_INSTANCE=$(oci container-instances container-instance list \
          --compartment-id ${{ secrets.OCI_COMPARTMENT_OCID }} \
          --display-name ${{ env.CONTAINER_NAME }} \
          --query 'data[0].id' --raw-output 2>/dev/null || echo "null")
        
        if [ "$EXISTING_INSTANCE" != "null" ] && [ "$EXISTING_INSTANCE" != "" ]; then
          echo "Removendo instÃ¢ncia existente: $EXISTING_INSTANCE"
          oci container-instances container-instance delete \
            --container-instance-id $EXISTING_INSTANCE \
            --force
          
          # Aguardar remoÃ§Ã£o
          echo "Aguardando remoÃ§Ã£o da instÃ¢ncia..."
          sleep 30
        fi
        
        # Criar nova instÃ¢ncia
        echo "Criando nova instÃ¢ncia do container..."
        oci container-instances container-instance create \
          --compartment-id ${{ secrets.OCI_COMPARTMENT_OCID }} \
          --availability-domain ${{ secrets.OCI_AVAILABILITY_DOMAIN }} \
          --shape CI.Standard.E4.Flex \
          --shape-config '{"memory_in_gbs": 1, "ocpus": 0.5}' \
          --display-name ${{ env.CONTAINER_NAME }} \
          --containers '[{
            "display_name": "${{ env.CONTAINER_NAME }}",
            "image_url": "${{ secrets.OCI_REGISTRY_URL }}/${{ secrets.OCI_NAMESPACE }}/${{ env.DOCKER_IMAGE_NAME }}:latest",
            "environment_variables": {},
            "resource_config": {
              "memory_limit_in_gbs": 1,
              "vcpus_limit": 0.5
            }
          }]' \
          --vnics '[{
            "subnet_id": "${{ secrets.OCI_SUBNET_OCID }}",
            "assign_public_ip": true,
            "display_name": "${{ env.CONTAINER_NAME }}-vnic"
          }]' \
          --wait-for-state ACTIVE \
          --max-wait-seconds 900
    
    # 7. Obter IP pÃºblico da instÃ¢ncia
    - name: Get Container Instance IP
      run: |
        # Aguardar um pouco para garantir que a instÃ¢ncia esteja pronta
        sleep 10
        
        INSTANCE_ID=$(oci container-instances container-instance list \
          --compartment-id ${{ secrets.OCI_COMPARTMENT_OCID }} \
          --display-name ${{ env.CONTAINER_NAME }} \
          --query 'data[0].id' --raw-output)
        
        PUBLIC_IP=$(oci container-instances container-instance get \
          --container-instance-id $INSTANCE_ID \
          --query 'data.vnics[0]."public-ip"' --raw-output)
        
        echo "ğŸš€ Deploy concluÃ­do!"
        echo "ğŸ“ IP PÃºblico: $PUBLIC_IP"
        echo "ğŸŒ Acesse: http://$PUBLIC_IP:9090"
        echo "PUBLIC_IP=$PUBLIC_IP" >> $GITHUB_ENV
    
    # 8. Comentar no PR (se for um PR)
    - name: Comment PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ğŸš€ **Deploy realizado com sucesso!**
            
            ğŸ“ **IP PÃºblico:** ${{ env.PUBLIC_IP }}
            ğŸŒ **URL:** http://${{ env.PUBLIC_IP }}:9090
            ğŸ³ **Imagem:** ${{ secrets.OCI_REGISTRY_URL }}/${{ secrets.OCI_NAMESPACE }}/${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
            
            âœ… Sua aplicaÃ§Ã£o estÃ¡ rodando na OCI!`
          })